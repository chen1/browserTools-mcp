2025-09-26 10:03:05.3N [TEST] 🚀 开始monitor脚本退出机制验证测试
2025-09-26 10:03:05.3N [TEST] 测试时间: 2025年 9月26日 星期五 10时03分05秒 CST
2025-09-26 10:03:05.3N [TEST] 脚本目录: /Users/fwmh/browser-tools
2025-09-26 10:03:05.3N [TEST] 🧹 清理测试环境...
2025-09-26 10:03:07.3N [TEST] ✅ 测试环境清理完成
2025-09-26 10:03:07.3N [TEST] 开始执行测试场景...
2025-09-26 10:03:07.3N [TEST] === 测试场景1: 正常启动server和monitor，然后关闭server ===
2025-09-26 10:03:07.3N [TEST] 🚀 启动模拟server进程...
2025-09-26 10:03:07.3N [TEST] 模拟server进程启动，PID: 70422
2025-09-26 10:03:07.3N [TEST] 🚀 启动monitor脚本...
2025-09-26 10:03:07.3N [TEST] Monitor脚本启动，PID: 70429
2025-09-26 10:03:12.3N [TEST] ❌ Monitor脚本启动后立即退出了
2025-09-26 10:03:12.3N [TEST] 🧹 清理测试环境...
2025-09-26 10:03:14.3N [TEST] ✅ 测试环境清理完成
2025-09-26 10:03:14.3N [TEST] === 测试场景2: 测试引用计数机制 ===
2025-09-26 10:03:14.3N [TEST] 🚀 启动模拟server进程...
2025-09-26 10:03:14.3N [TEST] 🚀 启动monitor脚本（引用计数=1）...
2025-09-26 10:03:19.3N [TEST] 🛑 关闭server进程（但引用计数仍为1）...
2025-09-26 10:03:19.3N [TEST] ⏳ 等待进程 'browser-tools-server' 退出 (超时: 10秒)...
2025-09-26 10:03:19.3N [TEST] ✅ 进程 'browser-tools-server' 已退出
2025-09-26 10:03:29.3N [TEST] ✅ Monitor脚本在server关闭但引用计数>0时继续运行
2025-09-26 10:03:29.3N [TEST] 📉 将引用计数设为0...
2025-09-26 10:03:29.3N [TEST] ⏳ 等待进程 'mcp_cleanup_monitor' 退出 (超时: 60秒)...
2025-09-26 10:03:29.3N [TEST] 进程 'mcp_cleanup_monitor' 仍在运行 (数量: 1), 等待中... (0/60秒)
2025-09-26 10:03:30.3N [TEST] 进程 'mcp_cleanup_monitor' 仍在运行 (数量: 1), 等待中... (1/60秒)
2025-09-26 10:03:31.3N [TEST] 进程 'mcp_cleanup_monitor' 仍在运行 (数量: 1), 等待中... (2/60秒)
2025-09-26 10:03:32.3N [TEST] ✅ 进程 'mcp_cleanup_monitor' 已退出
2025-09-26 10:03:32.3N [TEST] ✅ 测试场景2通过: Monitor脚本在引用计数为0后正确退出
2025-09-26 10:03:32.3N [TEST] 🧹 清理测试环境...
2025-09-26 10:03:34.3N [TEST] ✅ 测试环境清理完成
2025-09-26 10:03:34.3N [TEST] === 测试场景3: 详细分析monitor脚本的退出条件 ===
2025-09-26 10:03:34.3N [TEST] 📋 Monitor脚本的退出条件分析:
2025-09-26 10:03:34.3N [TEST] 1. MCP进程数为0 且 引用计数为0 且 没有server进程在运行 -> 直接退出
2025-09-26 10:03:34.3N [TEST] 2. MCP进程数为0 且 引用计数为0 且 server运行超过10分钟 -> 等待30秒后清理并退出
2025-09-26 10:03:34.3N [TEST] 3. MCP进程数为0 且 引用计数为0 且 server运行不足10分钟但端口未监听 -> 清理并退出
2025-09-26 10:03:34.3N [TEST] 4. MCP进程数为0 但 引用计数>0 -> 继续监控
2025-09-26 10:03:34.3N [TEST] 🧪 测试条件1: 没有server进程的情况
2025-09-26 10:03:37.3N [TEST] ✅ 条件1通过: 没有server进程时monitor立即退出
2025-09-26 10:03:37.3N [TEST] 🧹 清理测试环境...
2025-09-26 10:03:40.3N [TEST] ✅ 测试环境清理完成
2025-09-26 10:03:40.3N [TEST] === 测试结果汇总 ===
2025-09-26 10:03:40.3N [TEST] 场景1: ❌ 失败
2025-09-26 10:03:40.3N [TEST] 场景2: ✅ 通过
2025-09-26 10:03:40.3N [TEST] 场景3: ✅ 通过
2025-09-26 10:03:40.3N [TEST] ⚠️ 有 1 个测试失败，需要进一步检查
